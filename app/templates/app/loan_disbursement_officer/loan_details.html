{% extends 'app/base.html' %}
{% load custom_filters %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Loan Disbursement Processing</h2>
        <a href="{% url 'loan_disbursement_officer_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    
    <div class="row">
        <!-- Left Column: Applicant Information -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">Applicant Information</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Basic Information</h4>
                            <table class="table">
                                <tr>
                                    <th>Loan ID:</th>
                                    <td>{{ loan.loan_id }}</td>
                                </tr>
                                <tr>
                                    <th>Reference Number:</th>
                                    <td>{{ loan.reference_number }}</td>
                                </tr>
                                <tr>
                                    <th>Date Applied:</th>
                                    <td>{{ loan.created_at|date:"F d, Y" }}</td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        <span class="badge 
                                            {% if loan.status.status == 'PENDING' %}bg-warning
                                            {% elif loan.status.status == 'PROCEED_CI' %}bg-info
                                            {% elif loan.status.status == 'PROCEED_LAO' %}bg-primary
                                            {% elif loan.status.status == 'PROCEED_LDO' %}bg-primary
                                            {% elif loan.status.status == 'COMPLETED' %}bg-success
                                            {% elif loan.status.status == 'HOLD' %}bg-secondary
                                            {% elif loan.status.status == 'CANCELLED' or loan.status.status == 'DECLINED' %}bg-danger
                                            {% endif %}">
                                            {{ loan.status.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="col-md-6">
                            <h4>Personal Information</h4>
                            {% if loan.personal_info %}
                                <table class="table">
                                    <tr>
                                        <th>Name:</th>
                                        <td>{{ loan.personal_info.last_name }}, {{ loan.personal_info.first_name }} {{ loan.personal_info.middle_name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Gender:</th>
                                        <td>{{ loan.personal_info.get_gender_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Date of Birth:</th>
                                        <td>{{ loan.personal_info.date_of_birth|date:"F d, Y" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Age:</th>
                                        <td>{{ loan.personal_info.age }}</td>
                                    </tr>
                                    <tr>
                                        <th>Civil Status:</th>
                                        <td>{{ loan.personal_info.get_civil_status_display }}</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No personal information available.</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h4>Contact Information</h4>
                            {% if loan.contact_info %}
                                <table class="table">
                                    <tr>
                                        <th>Contact Number:</th>
                                        <td>{{ loan.contact_info.contact_number }}</td>
                                    </tr>
                                    <tr>
                                        <th>Email:</th>
                                        <td>{{ loan.contact_info.email_address }}</td>
                                    </tr>
                                    <tr>
                                        <th>Address:</th>
                                        <td>{{ loan.contact_info.no_and_street }}, {{ loan.contact_info.barangay }}, {{ loan.contact_info.municipality }}, {{ loan.contact_info.province }}</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No contact information available.</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h4>Source of Income</h4>
                            {% if loan.employment %}
                                <table class="table">
                                    <tr>
                                        <th>Employment Status:</th>
                                        <td>{{ loan.employment.get_employment_status_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Source of Funds:</th>
                                        <td>{{ loan.employment.get_source_of_funds_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Employer/Business:</th>
                                        <td>{{ loan.employment.employer_business_name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Contact Number:</th>
                                        <td>{{ loan.employment.employer_contact_number }}</td>
                                    </tr>
                                    <tr>
                                        <th>Position:</th>
                                        <td>{{ loan.employment.position }}</td>
                                    </tr>
                                    <tr>
                                        <th>Monthly Income:</th>
                                        <td>â‚±{{ loan.employment.monthly_net_income|floatformat:2|intcomma }}</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No employment information available.</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h4>Educational Background</h4>
                            {% if loan.education %}
                                <table class="table">
                                    <tr>
                                        <th>Education Level:</th>
                                        <td>{{ loan.education.get_education_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Course:</th>
                                        <td>{{ loan.education.course }}</td>
                                    </tr>
                                    <tr>
                                        <th>School Last Attended:</th>
                                        <td>{{ loan.education.school_last_attended }}</td>
                                    </tr>
                                    <tr>
                                        <th>Year Graduated:</th>
                                        <td>{{ loan.education.year_graduated }}</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No educational information available.</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h4>Spouse/Co-Borrower Information</h4>
                            {% if loan.spouse %}
                                <table class="table">
                                    <tr>
                                        <th>Name:</th>
                                        <td>{{ loan.spouse.last_name }}, {{ loan.spouse.first_name }} {{ loan.spouse.middle_name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Relation:</th>
                                        <td>{{ loan.spouse.relation_to_borrower }}</td>
                                    </tr>
                                    <tr>
                                        <th>Date of Birth:</th>
                                        <td>{{ loan.spouse.date_of_birth|date:"F d, Y" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Education:</th>
                                        <td>{{ loan.spouse.get_education_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Employer/Business:</th>
                                        <td>{{ loan.spouse.employer_business_name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Contact Number:</th>
                                        <td>{{ loan.spouse.employer_contact_number }}</td>
                                    </tr>
                                    <tr>
                                        <th>Monthly Income:</th>
                                        <td>â‚±{{ loan.spouse.net_income|floatformat:2|intcomma }}</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No spouse/co-borrower information available.</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h4>Vehicle Information</h4>
                            {% if loan.vehicle %}
                                <table class="table">
                                    <tr>
                                        <th>Make/Brand:</th>
                                        <td>{{ loan.vehicle.make_brand }}</td>
                                    </tr>
                                    <tr>
                                        <th>Model/Series:</th>
                                        <td>{{ loan.vehicle.series }}</td>
                                    </tr>
                                    <tr>
                                        <th>Year Model:</th>
                                        <td>{{ loan.vehicle.year_model }}</td>
                                    </tr>
                                    <tr>
                                        <th>Variant:</th>
                                        <td>{{ loan.vehicle.variant }}</td>
                                    </tr>
                                    <tr>
                                        <th>Color:</th>
                                        <td>{{ loan.vehicle.color }}</td>
                                    </tr>
                                    <tr>
                                        <th>Transmission:</th>
                                        <td>{{ loan.vehicle.get_transmission_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Fuel Type:</th>
                                        <td>{{ loan.vehicle.get_fuel_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Plate Number:</th>
                                        <td>{{ loan.vehicle.plate_no|default:"Not Available" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Engine Number:</th>
                                        <td>{{ loan.vehicle.engine_no }}</td>
                                    </tr>
                                    <tr>
                                        <th>Chassis Number:</th>
                                        <td>{{ loan.vehicle.chassis_no }}</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No vehicle information available.</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h4>Dealer Information</h4>
                            {% if loan.vehicle %}
                                <table class="table">
                                    <tr>
                                        <th>Dealer Name:</th>
                                        <td>{{ loan.vehicle.dealer_name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Dealer Address:</th>
                                        <td>{{ loan.vehicle.dealer_address }}</td>
                                    </tr>
                                    <tr>
                                        <th>Contact Number:</th>
                                        <td>{{ loan.vehicle.dealer_contact_number }}</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No dealer information available.</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h4>Loan Details</h4>
                            {% if loan.loan_details %}
                                <table class="table">
                                    <tr>
                                        <th>Loan Type:</th>
                                        <td>{{ loan.loan_details.get_loan_type_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Loan Purpose:</th>
                                        <td>{{ loan.loan_details.get_loan_purpose_display }}</td>
                                    </tr>
                                    <tr>
                                        <th>Vehicle Value:</th>
                                        <td>â‚±{{ loan.loan_details.estimated_vehicle_value|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <th>Down Payment:</th>
                                        <td>{{ loan.loan_details.down_payment_percentage|mul:100|floatformat:2 }}% (â‚±{{ loan.loan_details.estimated_vehicle_value|mul:loan.loan_details.down_payment_percentage|floatformat:2|intcomma }})</td>
                                    </tr>
                                    <tr>
                                        <th>Loan Amount:</th>
                                        <td>â‚±{{ loan.loan_details.loan_amount_applied|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <th>Term:</th>
                                        <td>{{ loan.loan_details.loan_amount_term }} months</td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No loan details available.</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h4>Documents</h4>
                            {% if loan.documents %}
                                <table class="table">
                                    <tr>
                                        <th>Valid ID:</th>
                                        <td>
                                            {% if loan.documents.valid_id %}
                                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#validIdModal">
                                                    View
                                                </button>
                                            {% else %}
                                                Not uploaded
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Proof of Income:</th>
                                        <td>
                                            {% if loan.documents.proof_of_income %}
                                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#proofOfIncomeModal">
                                                    View
                                                </button>
                                            {% else %}
                                                Not uploaded
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Utility Bill:</th>
                                        <td>
                                            {% if loan.documents.utility_bill %}
                                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#utilityBillModal">
                                                    View
                                                </button>
                                            {% else %}
                                                Not uploaded
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            {% else %}
                                <div class="alert alert-warning">No documents available.</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h4>Monthly Cash Flow</h4>
                            {% if loan.cash_flow %}
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Income</h5>
                                    <table class="table">
                                        <tr>
                                            <th>Applicant Income:</th>
                                            <td>â‚±{{ loan.cash_flow.applicant_total_income|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <th>Spouse Income:</th>
                                            <td>â‚±{{ loan.cash_flow.spouse_total_income|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <th>Total Income:</th>
                                            <td>â‚±{{ loan.cash_flow.total_income|floatformat:2|intcomma }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5>Expenses</h5>
                                    <table class="table">
                                        <tr>
                                            <th>Total Expenses:</th>
                                            <td>â‚±{{ loan.cash_flow.total_expenses|floatformat:2|intcomma }}</td>
                                        </tr>
                                        <tr>
                                            <th>Net Disposal:</th>
                                            <td>â‚±{{ loan.cash_flow.net_disposal|floatformat:2|intcomma }}</td>
                                        </tr>
                                        {% if loan.loan_details %}
                                            <tr>
                                                <th>Monthly Payment:</th>
                                                <td>â‚±{{ loan.loan_details.monthly_amortization|floatformat:2|intcomma }}</td>
                                            </tr>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                            {% else %}
                                <div class="alert alert-warning">No cash flow information available.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    {% if loan_amortization %}
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h3 class="card-title mb-0">Loan Amortization</h3>
                            </div>
                            <div class="card-body">
                                <table class="table">
                                    <tr>
                                        <th>Loan Amount:</th>
                                        <td>â‚±{{ loan_amortization.loan_amount|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <th>Interest Rate:</th>
                                        <td>{{ loan_amortization.interest_rate|floatformat:2 }}%</td>
                                    </tr>
                                    <tr>
                                        <th>Term:</th>
                                        <td>{{ loan_amortization.term_months }} months</td>
                                    </tr>
                                    <tr>
                                        <th>Monthly Payment:</th>
                                        <td>â‚±{{ loan_amortization.monthly_payment|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <th>Total Payment:</th>
                                        <td>â‚±{{ loan_amortization.total_payment|floatformat:2|intcomma }}</td>
                                    </tr>
                                    <tr>
                                        <th>Total Interest:</th>
                                        <td>â‚±{{ loan_amortization.total_interest|floatformat:2|intcomma }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    {% if dti_ratio %}
                        <div class="card mb-4">
                            <div class="card-header {% if dti_ratio <= 30 %}bg-success{% elif dti_ratio <= 40 %}bg-warning{% else %}bg-danger{% endif %} text-white">
                                <h3 class="card-title mb-0">Debt-to-Income Ratio</h3>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <h1 class="display-4">{{ dti_ratio|floatformat:2 }}%</h1>
                                    <p class="lead">
                                        {% if dti_ratio <= 30 %}
                                            <span class="text-success">Good</span> - Debt payments are manageable relative to income.
                                        {% elif dti_ratio <= 40 %}
                                            <span class="text-warning">Caution</span> - Debt payments are significant relative to income.
                                        {% else %}
                                            <span class="text-danger">High Risk</span> - Debt payments are too high relative to income.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Column: Loan Disbursement Processing -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">Loan Disbursement Details</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="form-group mb-3">
                            <label for="{{ form.disbursement_date.id_for_label }}" class="form-label">Disbursement Date *</label>
                            {{ form.disbursement_date }}
                            {% if form.disbursement_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.disbursement_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="{{ form.maturity_date.id_for_label }}" class="form-label">Maturity Date *</label>
                            {{ form.maturity_date }}
                            {% if form.maturity_date.errors %}
                                <div class="invalid-feedback d-block">{{ form.maturity_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">Disbursement Status *</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group mb-3">
                            <label for="{{ form.remarks.id_for_label }}" class="form-label">Remarks *</label>
                            <textarea name="{{ form.remarks.name }}" id="{{ form.remarks.id_for_label }}" class="form-control" rows="3" placeholder="Enter your disbursement processing remarks...">{{ form.remarks.value|default:'' }}</textarea>
                            {% if form.remarks.errors %}
                                <div class="invalid-feedback d-block">{{ form.remarks.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">Save Disbursement Details</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h3 class="card-title mb-0">Loan Approval Decision</h3>
                </div>
                <div class="card-body">
                    {% if loan.loan_approval_officer_remarks %}
                        <table class="table">
                            <tr>
                                <th>Officer Name:</th>
                                <td>{{ loan.loan_approval_officer_remarks.loan_approval_officer_name }}</td>
                            </tr>
                            <tr>
                                <th>Approval Status:</th>
                                <td>
                                    <span class="badge {% if loan.loan_approval_officer_remarks.approval_status == 'APPROVED' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ loan.loan_approval_officer_remarks.get_approval_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% if loan.loan_approval_officer_remarks.remarks %}
                                <tr>
                                    <th>Remarks:</th>
                                    <td>{{ loan.loan_approval_officer_remarks.remarks }}</td>
                                </tr>
                            {% endif %}
                        </table>
                    {% else %}
                        <div class="alert alert-warning">No loan approval decision available.</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h3 class="card-title mb-0">Credit Investigator Assessment</h3>
                </div>
                <div class="card-body">
                    {% if loan.credit_investigator_remarks %}
                        <table class="table">
                            <tr>
                                <th>Investigator Name:</th>
                                <td>{{ loan.credit_investigator_remarks.credit_investigator_name }}</td>
                            </tr>
                            <tr>
                                <th>Documents Verified:</th>
                                <td>
                                    <span class="badge {% if loan.credit_investigator_remarks.verified == 'YES' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ loan.credit_investigator_remarks.get_verified_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Credit Risk:</th>
                                <td>
                                    <span class="badge 
                                        {% if loan.credit_investigator_remarks.credit_risk_assessment == 'LOW' %}bg-success
                                        {% elif loan.credit_investigator_remarks.credit_risk_assessment == 'MEDIUM' %}bg-warning
                                        {% elif loan.credit_investigator_remarks.credit_risk_assessment == 'HIGH' %}bg-danger
                                        {% endif %}">
                                        {{ loan.credit_investigator_remarks.get_credit_risk_assessment_display }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    {% else %}
                        <div class="alert alert-warning">No credit investigator assessment available.</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <h3 class="card-title mb-0">Marketing Officer Remarks</h3>
                </div>
                <div class="card-body">
                    {% if loan.marketing_officer_remarks %}
                        <table class="table">
                            <tr>
                                <th>Officer Name:</th>
                                <td>{{ loan.marketing_officer_remarks.marketing_officer_name }}</td>
                            </tr>
                            <tr>
                                <th>Documents Complete:</th>
                                <td>
                                    <span class="badge {% if loan.marketing_officer_remarks.complete_documents == 'YES' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ loan.marketing_officer_remarks.get_complete_documents_display }}
                                    </span>
                                </td>
                            </tr>
                            {% if loan.marketing_officer_remarks.remarks %}
                                <tr>
                                    <th>Remarks:</th>
                                    <td>{{ loan.marketing_officer_remarks.remarks }}</td>
                                </tr>
                            {% endif %}
                        </table>
                    {% else %}
                        <div class="alert alert-warning">No marketing officer remarks available.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Modals -->
{% if loan.documents %}
    {% if loan.documents.valid_id %}
        <div class="modal fade" id="validIdModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Valid ID</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="{{ loan.documents.valid_id.url }}" class="img-fluid" alt="Valid ID">
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {% if loan.documents.proof_of_income %}
        <div class="modal fade" id="proofOfIncomeModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Proof of Income</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="{{ loan.documents.proof_of_income.url }}" class="img-fluid" alt="Proof of Income">
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {% if loan.documents.utility_bill %}
        <div class="modal fade" id="utilityBillModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Utility Bill</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="{{ loan.documents.utility_bill.url }}" class="img-fluid" alt="Utility Bill">
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endif %}

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to save and proceed with the loan disbursement?</p>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSave">Yes, Proceed</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const form = document.querySelector('form');
        const confirmSaveBtn = document.getElementById('confirmSave');
        
        confirmSaveBtn.addEventListener('click', function() {
            form.submit();
        });

        const disbursementDateInput = document.getElementById('{{ form.disbursement_date.id_for_label }}');
        const maturityDateInput = document.getElementById('{{ form.maturity_date.id_for_label }}');

        disbursementDateInput.addEventListener('change', function() {
            if (this.value) {
                // Get the disbursement date
                const disbursementDate = new Date(this.value);
                
                // Get loan term in months from the loan details
                {% if loan.loan_details %}
                const loanTerm = {{ loan.loan_details.loan_amount_term }};
                {% else %}
                const loanTerm = 12; // Default to 12 months if no loan details
                {% endif %}
                
                // Calculate the maturity date by adding the loan term months
                const maturityDate = new Date(disbursementDate);
                maturityDate.setMonth(maturityDate.getMonth() + loanTerm);
                
                // Format the date as YYYY-MM-DD for the input field
                const formattedDate = maturityDate.toISOString().split('T')[0];
                maturityDateInput.value = formattedDate;
            }
        });
    });
</script>
{% endblock %} 