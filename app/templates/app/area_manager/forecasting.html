{% extends 'app/base.html' %}
{% load static %}

{% block title %}Loan Disbursement Forecasts - Area Manager{% endblock %}

{% block content %}

{% block extra_css %}
<style>
    /* Cursor styles for charts with zoom enabled */
    canvas.chartjs-render-monitor {
        cursor: crosshair;
    }
    
    /* Show zoom cursor when hovering over charts */
    .card-body canvas {
        transition: all 0.2s ease;
    }
    
    .card-body canvas:hover {
        box-shadow: 0 0 0 2px rgba(54, 162, 235, 0.3);
    }
    
    /* Style for reset zoom button */
    .reset-zoom {
        z-index: 10;
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }
    
    .reset-zoom:hover {
        opacity: 1;
    }
    
    /* Fixed height for chart containers to prevent expansion */
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
    
    /* Styles for the insights panel */
    .insight-icon, .recommendation-icon {
        width: 45px;
        height: 45px;
        min-width: 45px;
        min-height: 45px;
        color: white;
    }
    
    .insight-icon {
        background-color: #3498db;
    }
    
    .recommendation-icon {
        background-color: #2ecc71;
    }
    
    /* Trend badge styles */
    .trend-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.6rem;
        border-radius: 2rem;
        font-weight: 600;
    }
    
    .trend-increasing {
        background-color: rgba(46, 204, 113, 0.15);
        color: #2ecc71;
    }
    
    .trend-decreasing {
        background-color: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
    }
    
    .trend-stable {
        background-color: rgba(52, 152, 219, 0.15);
        color: #3498db;
    }
    
    .trend-neutral {
        background-color: rgba(149, 165, 166, 0.15);
        color: #95a5a6;
    }
    
    /* Header styles based on trend */
    .header-increasing {
        background-color: rgba(46, 204, 113, 0.1);
        border-left: 4px solid #2ecc71;
    }
    
    .header-decreasing {
        background-color: rgba(231, 76, 60, 0.1);
        border-left: 4px solid #e74c3c;
    }
    
    .header-stable {
        background-color: rgba(52, 152, 219, 0.1);
        border-left: 4px solid #3498db;
    }
    
    .header-neutral {
        background-color: rgba(149, 165, 166, 0.1);
        border-left: 4px solid #95a5a6;
    }
</style>
{% endblock %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Loan Disbursement Forecasts</h2>
        <a href="{% url 'area_manager_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    <!-- Loading indicator for forecast regeneration -->
    <div id="regenerate-loading" class="alert alert-info d-none">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Generating new forecasts based on the latest loan data. This may take a minute...</span>
        </div>
    </div>
    
    <!-- Success/error messages -->
    <div id="regenerate-success" class="alert alert-success d-none">
        Forecasts have been successfully updated with the latest loan data!
    </div>
    
    <div id="regenerate-error" class="alert alert-danger d-none">
        An error occurred while updating forecasts. Please try again later.
    </div>

    <!-- Forecasting Tabs -->
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Forecast Analysis/Insights</h3>
                <button type="button" id="regenerate-forecasts" class="btn btn-light" onclick="handleRegenerate()">
                    <i class="fas fa-sync-alt me-1"></i> Update Forecasts
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info py-2 mb-3">
                <small><i class="fas fa-info-circle me-1"></i> <strong>Tip:</strong> Use mouse wheel to zoom in/out of charts. Click and drag to pan. Use the reset zoom button to return to the original view.</small>
            </div>
            <ul class="nav nav-tabs" id="forecastTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-selected="true">Weekly Forecast</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-selected="false">Monthly Forecast</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="quarterly-tab" data-bs-toggle="tab" data-bs-target="#quarterly" type="button" role="tab" aria-selected="false">Quarterly Forecast</button>
                </li>
            </ul>
            <div class="tab-content mt-3" id="forecastTabsContent">
                <!-- Weekly Forecast Tab -->
                <div class="tab-pane fade show active" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
                    <h4>Weekly Loan Disbursement Forecast</h4>
                    
                    <!-- Historical Data -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Historical Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="weeklyHistoricalChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Series Decomposition -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Time Series Decomposition</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Trend</span>
                                            <span class="small text-muted ms-2">Long-term progression over time</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="weeklyTrendChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Seasonal Pattern</span>
                                            <span class="small text-muted ms-2">Recurring patterns and cyclical fluctuations</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="weeklySeasonalChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Residual</span>
                                            <span class="small text-muted ms-2">Unexplained variations after trend and seasonal effects</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="weeklyResidualChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Future Forecast -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Future Forecast</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="weeklyForecastChart"></canvas>
                            </div>
                            
                            <!-- Insights Panel -->
                            <div id="weeklyInsightsPanel" class="mt-4 d-none">
                                <div class="card border-0 shadow-sm" id="weeklyInsightsCard">
                                    <div class="card-header py-3" id="weeklyInsightsHeader">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-chart-line fa-lg me-2"></i>
                                            <h6 class="mb-0 fw-bold">FORECAST ANALYSIS</h6>
                                            <div class="ms-auto" id="weeklyTrendBadge"></div>
                                        </div>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="d-flex mb-3">
                                                    <div class="insight-icon rounded-circle d-flex align-items-center justify-content-center me-3">
                                                        <i class="fas fa-lightbulb"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="text-muted mb-2 small text-uppercase">Insight</h6>
                                                        <p id="weeklyInsight" class="mb-0"></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex">
                                                    <div class="recommendation-icon rounded-circle d-flex align-items-center justify-content-center me-3">
                                                        <i class="fas fa-clipboard-check"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="text-muted mb-2 small text-uppercase">Recommendation</h6>
                                                        <p id="weeklyRecommendation" class="mb-0"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Forecast Tab -->
                <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
                    <h4>Monthly Loan Disbursement Forecast</h4>
                    
                    <!-- Historical Data -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Historical Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="monthlyHistoricalChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Series Decomposition -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Time Series Decomposition</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Trend</span>
                                            <span class="small text-muted ms-2">Long-term progression over time</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="monthlyTrendChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Seasonal Pattern</span>
                                            <span class="small text-muted ms-2">Recurring patterns and cyclical fluctuations</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="monthlySeasonalChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Residual</span>
                                            <span class="small text-muted ms-2">Unexplained variations after trend and seasonal effects</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="monthlyResidualChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Future Forecast -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Future Forecast</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="monthlyForecastChart"></canvas>
                            </div>
                            
                            <!-- Insights Panel -->
                            <div id="monthlyInsightsPanel" class="mt-4 d-none">
                                <div class="card border-0 shadow-sm" id="monthlyInsightsCard">
                                    <div class="card-header py-3" id="monthlyInsightsHeader">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-chart-line fa-lg me-2"></i>
                                            <h6 class="mb-0 fw-bold">FORECAST ANALYSIS</h6>
                                            <div class="ms-auto" id="monthlyTrendBadge"></div>
                                        </div>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="d-flex mb-3">
                                                    <div class="insight-icon rounded-circle d-flex align-items-center justify-content-center me-3">
                                                        <i class="fas fa-lightbulb"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="text-muted mb-2 small text-uppercase">Insight</h6>
                                                        <p id="monthlyInsight" class="mb-0"></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex">
                                                    <div class="recommendation-icon rounded-circle d-flex align-items-center justify-content-center me-3">
                                                        <i class="fas fa-clipboard-check"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="text-muted mb-2 small text-uppercase">Recommendation</h6>
                                                        <p id="monthlyRecommendation" class="mb-0"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quarterly Forecast Tab -->
                <div class="tab-pane fade" id="quarterly" role="tabpanel" aria-labelledby="quarterly-tab">
                    <h4>Quarterly Loan Disbursement Forecast</h4>
                    
                    <!-- Historical Data -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Historical Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="quarterlyHistoricalChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Series Decomposition -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Time Series Decomposition</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Trend</span>
                                            <span class="small text-muted ms-2">Long-term progression over time</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="quarterlyTrendChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Seasonal Pattern</span>
                                            <span class="small text-muted ms-2">Recurring patterns and cyclical fluctuations</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="quarterlySeasonalChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header py-1 px-2 bg-light">
                                            <span class="small fw-bold">Residual</span>
                                            <span class="small text-muted ms-2">Unexplained variations after trend and seasonal effects</span>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="chart-container">
                                                <canvas id="quarterlyResidualChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Future Forecast -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Future Forecast</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="quarterlyForecastChart"></canvas>
                            </div>
                            
                            <!-- Insights Panel -->
                            <div id="quarterlyInsightsPanel" class="mt-4 d-none">
                                <div class="card border-0 shadow-sm" id="quarterlyInsightsCard">
                                    <div class="card-header py-3" id="quarterlyInsightsHeader">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-chart-line fa-lg me-2"></i>
                                            <h6 class="mb-0 fw-bold">FORECAST ANALYSIS</h6>
                                            <div class="ms-auto" id="quarterlyTrendBadge"></div>
                                        </div>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="d-flex mb-3">
                                                    <div class="insight-icon rounded-circle d-flex align-items-center justify-content-center me-3">
                                                        <i class="fas fa-lightbulb"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="text-muted mb-2 small text-uppercase">Insight</h6>
                                                        <p id="quarterlyInsight" class="mb-0"></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex">
                                                    <div class="recommendation-icon rounded-circle d-flex align-items-center justify-content-center me-3">
                                                        <i class="fas fa-clipboard-check"></i>
                                                    </div>
                                                    <div>
                                                        <h6 class="text-muted mb-2 small text-uppercase">Recommendation</h6>
                                                        <p id="quarterlyRecommendation" class="mb-0"></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Add chartjs-plugin-annotation for improved annotations -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@latest"></script>
<!-- Add Moment.js for better date handling -->
<script src="https://cdn.jsdelivr.net/npm/moment@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@latest"></script>
<!-- Add Zoom plugin -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@latest"></script>

<script>
// Store chart instances
let charts = {};
// Cache storage for chart data
let chartDataCache = {};
// Time when data was last fetched (in milliseconds)
let lastFetchTime = {};
// Cache expiration time in milliseconds (30 minutes)
const CACHE_EXPIRATION = 30 * 60 * 1000;

// Chart colors with better palette
const CHART_COLORS = {
    blue: 'rgba(54, 162, 235, 1)',
    blueLight: 'rgba(54, 162, 235, 0.2)',
    red: 'rgba(255, 99, 132, 1)',
    redLight: 'rgba(255, 99, 132, 0.2)',
    green: 'rgba(75, 192, 192, 1)',
    greenLight: 'rgba(75, 192, 192, 0.2)',
    purple: 'rgba(153, 102, 255, 1)',
    purpleLight: 'rgba(153, 102, 255, 0.2)',
    orange: 'rgba(255, 159, 64, 1)',
    orangeLight: 'rgba(255, 159, 64, 0.2)',
    grey: 'rgba(201, 203, 207, 1)',
    greyLight: 'rgba(201, 203, 207, 0.2)'
};

// Default background colors for charts
const DEFAULT_BACKGROUNDS = {
    historical: {
        backgroundColor: CHART_COLORS.greenLight,
        borderColor: CHART_COLORS.green
    },
    trend: {
        backgroundColor: CHART_COLORS.blueLight,
        borderColor: CHART_COLORS.blue
    },
    seasonal: {
        backgroundColor: CHART_COLORS.redLight,
        borderColor: CHART_COLORS.red
    },
    residual: {
        backgroundColor: CHART_COLORS.purpleLight,
        borderColor: CHART_COLORS.purple
    },
    forecast: {
        backgroundColor: CHART_COLORS.orangeLight,
        borderColor: CHART_COLORS.orange
    }
};

// Chart configuration and data loading
const baseChartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'top',
            labels: {
                padding: 20,
                boxWidth: 15,
                font: {
                    size: 13
                }
            }
        },
        tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
                label: function(context) {
                    return context.dataset.label + ': ' + new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'PHP'
                    }).format(context.parsed.y);
                }
            },
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: {
                size: 14
            },
            bodyFont: {
                size: 13
            },
            padding: 10,
            displayColors: true
        },
        annotation: {
            annotations: {}
        },
        zoom: {
            zoom: {
                wheel: {
                    enabled: true,
                    speed: 0.05,
                },
                pinch: {
                    enabled: true
                },
                mode: 'xy',
                onZoomComplete: function({chart}) {
                    // Show reset zoom button when zoomed
                    chart.canvas.parentNode.querySelector('.reset-zoom')?.classList.remove('d-none');
                }
            },
            pan: {
                enabled: true,
                mode: 'xy',
                threshold: 5
            },
            limits: {
                y: {min: 'original', max: 'original'}
            }
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                lineWidth: 1
            },
            ticks: {
                // Include PHP symbol and thousand separators
                callback: function(value) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'PHP',
                        maximumFractionDigits: 0
                    }).format(value);
                },
                // Show more ticks
                count: 6,
                font: {
                    size: 11
                }
            },
            title: {
                display: true,
                text: 'Loan Amount (PHP)',
                font: {
                    size: 14,
                    weight: 'bold'
                },
                padding: {top: 10, bottom: 10}
            }
        },
        x: {
            grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                lineWidth: 1
            },
            title: {
                display: true,
                text: 'Date',
                font: {
                    size: 14,
                    weight: 'bold'
                },
                padding: {top: 10, bottom: 10}
            },
            ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: {
                    size: 11
                }
            }
        }
    },
    interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
    },
    animations: {
        tension: {
            duration: 1000,
            easing: 'easeInOutQuad'
        }
    },
    elements: {
        line: {
            tension: 0.3, // Smoother curves
            borderWidth: 2
        },
        point: {
            radius: 3,
            hoverRadius: 5,
            hitRadius: 10
        }
    }
};

// Function to create or update a chart
function createChart(canvasId, data, type = 'line') {
    // Get the canvas
    const canvas = document.getElementById(canvasId);
    
    // Get parent container
    const container = canvas.parentNode;
    
    // Destroy existing chart if it exists
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    // Get chart specific options
    const options = getChartOptions(canvasId, data);
    
    const ctx = canvas.getContext('2d');
    charts[canvasId] = new Chart(ctx, {
        type: type,
        data: data,
        options: options
    });
    
    // Add reset zoom button if it doesn't exist
    if (!container.querySelector('.reset-zoom')) {
        const resetButton = document.createElement('button');
        resetButton.className = 'btn btn-sm btn-outline-secondary reset-zoom position-absolute top-0 end-0 m-2 d-none';
        resetButton.innerHTML = '<i class="fas fa-search-minus me-1"></i>Reset Zoom';
        resetButton.onclick = function() {
            charts[canvasId].resetZoom();
            resetButton.classList.add('d-none');
        };
        container.style.position = 'relative';
        container.appendChild(resetButton);
    }
    
    return charts[canvasId];
}

// Get specific chart options based on chart type
function getChartOptions(canvasId, data) {
    const options = JSON.parse(JSON.stringify(baseChartOptions)); // Deep clone
    
    // Set chart title
    options.plugins.title = {
        display: true,
        text: getChartTitle(canvasId),
        font: {
            size: 16,
            weight: 'bold'
        },
        padding: {top: 10, bottom: 20}
    };
    
    // Add specific options for forecast charts
    if (canvasId.includes('Forecast')) {
        // Add vertical line to mark the start of forecast
        const historicalDataLength = data.datasets[0].data.filter(v => v !== null).length;
        
        options.plugins.annotation = {
            annotations: {
                line1: {
                    type: 'line',
                    xMin: historicalDataLength - 1,
                    xMax: historicalDataLength - 1,
                    borderColor: 'rgba(0, 0, 0, 0.5)',
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                        display: true,
                        content: 'Forecast Start',
                        position: 'start',
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        font: {
                            size: 12
                        }
                    }
                }
            }
        };
    }
    
    // Add specific options for seasonal charts
    if (canvasId.includes('Seasonal')) {
        options.scales.y.title.text = 'Seasonal Effect (PHP)';
        options.scales.y.beginAtZero = false;
    }
    
    // Add specific options for residual charts
    if (canvasId.includes('Residual')) {
        options.scales.y.title.text = 'Residual (PHP)';
        options.scales.y.beginAtZero = false;
        
        // Add zero line
        options.plugins.annotation = {
            annotations: {
                line1: {
                    type: 'line',
                    yMin: 0,
                    yMax: 0,
                    borderColor: 'rgba(0, 0, 0, 0.3)',
                    borderWidth: 1,
                    borderDash: [6, 6]
                }
            }
        };
    }
    
    return options;
}

// Helper function to get chart title
function getChartTitle(canvasId) {
    if (canvasId.includes('Historical')) {
        return 'Historical Loan Disbursements';
    } else if (canvasId.includes('Trend')) {
        return 'Long-term Trend Analysis';
    } else if (canvasId.includes('Seasonal')) {
        return 'Seasonal Pattern Analysis';
    } else if (canvasId.includes('Residual')) {
        return 'Residual Component Analysis';
    } else if (canvasId.includes('Forecast')) {
        return 'Future Loan Disbursement Forecast';
    }
    return '';
}

// Format datasets with consistent styling
function formatDatasets(data, chartType) {
    const datasets = [];
    
    // Historical chart
    if (chartType === 'historical') {
        datasets.push({
            label: 'Historical Loan Disbursements',
            data: data.historical.values,
            backgroundColor: DEFAULT_BACKGROUNDS.historical.backgroundColor,
            borderColor: DEFAULT_BACKGROUNDS.historical.borderColor,
            fill: true,
            tension: 0.3,
            borderWidth: 2
        });
    }
    
    // Trend chart
    else if (chartType === 'trend') {
        datasets.push({
            label: 'Trend Component',
            data: data.trend.values,
            backgroundColor: DEFAULT_BACKGROUNDS.trend.backgroundColor,
            borderColor: DEFAULT_BACKGROUNDS.trend.borderColor,
            fill: true,
            tension: 0.3,
            borderWidth: 2
        });
    }
    
    // Seasonal chart
    else if (chartType === 'seasonal') {
        datasets.push({
            label: 'Seasonal Component',
            data: data.seasonal.values,
            backgroundColor: DEFAULT_BACKGROUNDS.seasonal.backgroundColor,
            borderColor: DEFAULT_BACKGROUNDS.seasonal.borderColor,
            fill: true,
            tension: 0.3,
            borderWidth: 2
        });
    }
    
    // Residual chart
    else if (chartType === 'residual') {
        datasets.push({
            label: 'Residual Component',
            data: data.residual.values,
            backgroundColor: DEFAULT_BACKGROUNDS.residual.backgroundColor,
            borderColor: DEFAULT_BACKGROUNDS.residual.borderColor,
            fill: true,
            tension: 0.3,
            borderWidth: 2
        });
    }
    
    // Forecast chart
    else if (chartType === 'forecast') {
        datasets.push({
            label: 'Historical Data',
            data: [...data.historical.values, ...Array(data.forecast.values.length).fill(null)],
            backgroundColor: DEFAULT_BACKGROUNDS.historical.backgroundColor,
            borderColor: DEFAULT_BACKGROUNDS.historical.borderColor,
            fill: true,
            tension: 0.3,
            borderWidth: 2
        });
        
        datasets.push({
            label: 'Forecast (Predicted)',
            data: [...Array(data.historical.values.length).fill(null), ...data.forecast.values],
            backgroundColor: DEFAULT_BACKGROUNDS.forecast.backgroundColor,
            borderColor: DEFAULT_BACKGROUNDS.forecast.borderColor,
            fill: true,
            tension: 0.3,
            borderWidth: 2,
            borderDash: [5, 5],
            pointStyle: 'rectRot',
            pointRadius: 4,
            pointHoverRadius: 6
        });
    }
    
    return datasets;
}

// Function to load chart data from API or cache
async function loadChartData(frequency) {
    try {
        // Check if we have cached data that isn't expired
        const cachedData = getChartDataFromCache(frequency);
        if (cachedData) {
            console.log(`Using cached data for ${frequency} charts`);
            renderCharts(frequency, cachedData);
            return;
        }

        // Show loading indicator
        showLoading(true, frequency);
        
        const response = await fetch(`/area-manager/get-forecast-data/${frequency}/`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (!data || !data.historical || !data.historical.dates) {
            throw new Error('Invalid data format received from server');
        }
        
        // Hide loading indicator
        showLoading(false, frequency);
        
        // Save to cache
        saveChartDataToCache(frequency, data);
        
        // Render the charts
        renderCharts(frequency, data);
    } catch (error) {
        console.error('Error loading chart data:', error);
        // Hide loading indicator
        showLoading(false, frequency);
        
        // Display error message to user
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger';
        errorDiv.textContent = `Failed to load forecast data: ${error.message}`;
        document.querySelector(`#${frequency}`).prepend(errorDiv);
    }
}

// Function to render all charts for a frequency
function renderCharts(frequency, data) {
    createChart(`${frequency}HistoricalChart`, {
        labels: data.historical.dates,
        datasets: formatDatasets(data, 'historical')
    });

    createChart(`${frequency}TrendChart`, {
        labels: data.trend.dates,
        datasets: formatDatasets(data, 'trend')
    });

    createChart(`${frequency}SeasonalChart`, {
        labels: data.seasonal.dates,
        datasets: formatDatasets(data, 'seasonal')
    });

    createChart(`${frequency}ResidualChart`, {
        labels: data.residual.dates,
        datasets: formatDatasets(data, 'residual')
    });

    createChart(`${frequency}ForecastChart`, {
        labels: [...data.historical.dates, ...data.forecast.dates],
        datasets: formatDatasets(data, 'forecast')
    });
    
    // Display insights if available
    if (data.analysis) {
        displayInsights(frequency, data.analysis);
    }
}

// Function to save chart data to cache
function saveChartDataToCache(frequency, data) {
    try {
        // Store data in memory cache
        chartDataCache[frequency] = data;
        lastFetchTime[frequency] = Date.now();
        
        // Also store in sessionStorage for persistence across page refreshes
        sessionStorage.setItem(`chartData_${frequency}`, JSON.stringify(data));
        sessionStorage.setItem(`chartDataTime_${frequency}`, Date.now().toString());
        
        console.log(`Saved ${frequency} chart data to cache`);
    } catch (e) {
        console.error('Error saving to cache:', e);
        // If sessionStorage fails (e.g., due to quota exceeded), we'll still have in-memory cache
    }
}

// Function to get chart data from cache
function getChartDataFromCache(frequency) {
    // First check in-memory cache
    if (chartDataCache[frequency] && lastFetchTime[frequency]) {
        // Check if cache is still valid
        if (Date.now() - lastFetchTime[frequency] < CACHE_EXPIRATION) {
            return chartDataCache[frequency];
        }
    }
    
    // If not in memory, try sessionStorage
    try {
        const storedData = sessionStorage.getItem(`chartData_${frequency}`);
        const storedTime = sessionStorage.getItem(`chartDataTime_${frequency}`);
        
        if (storedData && storedTime) {
            const dataTime = parseInt(storedTime);
            
            // Check if cache is still valid
            if (Date.now() - dataTime < CACHE_EXPIRATION) {
                const data = JSON.parse(storedData);
                
                // Update in-memory cache too
                chartDataCache[frequency] = data;
                lastFetchTime[frequency] = dataTime;
                
                return data;
            }
        }
    } catch (e) {
        console.error('Error retrieving from cache:', e);
    }
    
    // No valid cache found
    return null;
}

// Clear chart cache - used when user explicitly refreshes data
function clearChartCache() {
    // Clear in-memory cache
    chartDataCache = {};
    lastFetchTime = {};
    
    // Clear sessionStorage cache
    try {
        Object.keys(sessionStorage).forEach(key => {
            if (key.startsWith('chartData_') || key.startsWith('chartDataTime_')) {
                sessionStorage.removeItem(key);
            }
        });
    } catch (e) {
        console.error('Error clearing cache:', e);
    }
    
    console.log('Chart cache cleared');
}

// Function to display insights and recommendations
function displayInsights(frequency, analysis) {
    const insightsPanel = document.getElementById(`${frequency}InsightsPanel`);
    const insightsCard = document.getElementById(`${frequency}InsightsCard`);
    const insightsHeader = document.getElementById(`${frequency}InsightsHeader`);
    const trendBadge = document.getElementById(`${frequency}TrendBadge`);
    const insightElement = document.getElementById(`${frequency}Insight`);
    const recommendationElement = document.getElementById(`${frequency}Recommendation`);
    
    if (!insightsPanel || !insightsCard || !insightsHeader || !trendBadge || !insightElement || !recommendationElement) {
        console.error(`Missing elements for ${frequency} insights`);
        return;
    }
    
    // Set content
    insightElement.textContent = analysis.insight;
    recommendationElement.textContent = analysis.recommendation;
    
    // Create trend badge
    let badgeText = 'Neutral';
    let badgeClass = 'trend-neutral';
    let headerClass = 'header-neutral';
    
    if (analysis.trend === 'increasing') {
        badgeText = 'Increasing';
        badgeClass = 'trend-increasing';
        headerClass = 'header-increasing';
    } else if (analysis.trend === 'decreasing') {
        badgeText = 'Decreasing';
        badgeClass = 'trend-decreasing';
        headerClass = 'header-decreasing';
    } else if (analysis.trend === 'stable') {
        badgeText = 'Stable';
        badgeClass = 'trend-stable';
        headerClass = 'header-stable';
    }
    
    trendBadge.innerHTML = `<span class="trend-badge ${badgeClass}">${badgeText}</span>`;
    
    // Set header style
    insightsHeader.className = `card-header py-3 ${headerClass}`;
    
    // Show the panel
    insightsPanel.classList.remove('d-none');
}

// Show/hide loading indicators for charts
function showLoading(show, frequency) {
    const tab = document.getElementById(frequency);
    
    if (show) {
        // Target only these specific chart containers by their IDs
        const chartIds = [
            `${frequency}HistoricalChart`,
            `${frequency}TrendChart`,
            `${frequency}SeasonalChart`, 
            `${frequency}ResidualChart`,
            `${frequency}ForecastChart`
        ];
        
        chartIds.forEach(chartId => {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;
            
            const container = canvas.parentElement;
            
            // Only add loading indicator if it doesn't already exist
            if (!container.querySelector('.chart-loading')) {
                const loader = document.createElement('div');
                loader.className = 'chart-loading position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75';
                loader.innerHTML = `
                    <div class="d-flex flex-column align-items-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Loading data...</div>
                    </div>
                `;
                container.style.position = 'relative';
                container.appendChild(loader);
            }
        });
    } else {
        // Remove all loading indicators
        const loaders = tab.querySelectorAll('.chart-loading');
        loaders.forEach(loader => loader.remove());
    }
}

// Load initial data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadChartData('weekly');
});

// Load data when switching tabs
document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('shown.bs.tab', function(e) {
        const frequency = e.target.id.replace('-tab', '');
        loadChartData(frequency);
    });
});

// Update charts when regenerating forecasts
function handleRegenerate() {
    const loadingIndicator = document.getElementById('regenerate-loading');
    const successMessage = document.getElementById('regenerate-success');
    const errorMessage = document.getElementById('regenerate-error');
    const regenerateBtn = document.getElementById('regenerate-forecasts');
    
    loadingIndicator.classList.remove('d-none');
    successMessage.classList.add('d-none');
    errorMessage.classList.add('d-none');
    regenerateBtn.disabled = true;
    
    // Clear cache before regenerating
    clearChartCache();
    
    fetch('/area-manager/regenerate-forecasts/')
        .then(response => response.json())
            .then(data => {
            loadingIndicator.classList.add('d-none');
            
            if (data.success) {
                successMessage.classList.remove('d-none');
                // Auto-hide success message after 5 seconds
                setTimeout(() => {
                    successMessage.classList.add('d-none');
                }, 5000);
                
                // Reload charts
                const activeTab = document.querySelector('.nav-link.active');
                const frequency = activeTab.id.replace('-tab', '');
                loadChartData(frequency);
            } else {
                errorMessage.textContent = data.error || 'An error occurred while updating forecasts.';
                errorMessage.classList.remove('d-none');
            }
            
            regenerateBtn.disabled = false;
            })
            .catch(error => {
            loadingIndicator.classList.add('d-none');
            errorMessage.textContent = error.message || 'An error occurred while updating forecasts.';
            errorMessage.classList.remove('d-none');
            regenerateBtn.disabled = false;
        });
}
</script>
{% endblock %} 