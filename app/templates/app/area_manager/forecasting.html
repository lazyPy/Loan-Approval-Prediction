{% extends 'app/base.html' %}
{% load static %}

{% block title %}Loan Disbursement Forecasts - Area Manager{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Loan Disbursement Forecasts</h2>
        <a href="{% url 'area_manager_dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    <!-- Loading indicator for forecast regeneration -->
    <div id="regenerate-loading" class="alert alert-info d-none">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Generating new forecasts based on the latest loan data. This may take a minute...</span>
        </div>
    </div>
    
    <!-- Success/error messages -->
    <div id="regenerate-success" class="alert alert-success d-none">
        Forecasts have been successfully updated with the latest loan data!
    </div>
    
    <div id="regenerate-error" class="alert alert-danger d-none">
        An error occurred while updating forecasts. Please try again later.
    </div>

    <!-- Forecasting Tabs -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Forecast Analysis</h3>
                <button type="button" id="regenerate-forecasts" class="btn btn-light" onclick="handleRegenerate()">
                    <i class="fas fa-sync-alt me-1"></i> Update Forecasts
                </button>
            </div>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="forecastTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-selected="true">Weekly Forecast</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-selected="false">Monthly Forecast</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="quarterly-tab" data-bs-toggle="tab" data-bs-target="#quarterly" type="button" role="tab" aria-selected="false">Quarterly Forecast</button>
                </li>
            </ul>
            <div class="tab-content mt-3" id="forecastTabsContent">
                <!-- Weekly Forecast Tab -->
                <div class="tab-pane fade show active" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
                    <h4>Weekly Loan Disbursement Forecast</h4>
                    
                    <div class="row" id="weekly-historical-data">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Historical Data</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img 
                                        src="{% static 'img/Weekly_Frequency_-_Historical_Data.png' %}" 
                                        class="img-fluid" 
                                        alt="Weekly Historical Data" 
                                        style="max-height: 400px;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No historical data available';"
                                    >
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Model Performance</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img 
                                        src="{% static 'img/Weekly_Frequency_-_Model_Performance.png' %}" 
                                        class="img-fluid" 
                                        alt="Weekly Model Performance" 
                                        style="max-height: 400px;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No model performance data available';"
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Series Decomposition -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Time Series Decomposition</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12 mb-4">
                                    <img 
                                        src="{% static 'img/Weekly_Frequency_-_Trend.png' %}" 
                                        class="img-fluid" 
                                        alt="Weekly Trend" 
                                        style="width: 100%;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No trend data available';"
                                    >
                                </div>
                                <div class="col-12 mb-4">
                                    <img 
                                        src="{% static 'img/Weekly_Frequency_-_Seasonal.png' %}" 
                                        class="img-fluid" 
                                        alt="Weekly Seasonal Pattern" 
                                        style="width: 100%;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No seasonal data available';"
                                    >
                                </div>
                                <div class="col-12">
                                    <img 
                                        src="{% static 'img/Weekly_Frequency_-_Residual.png' %}" 
                                        class="img-fluid" 
                                        alt="Weekly Residual" 
                                        style="width: 100%;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No residual data available';"
                                    >
                                </div>
                            </div>
                                    </div>
                            </div>
                            
                    <!-- Future Forecast -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Future Forecast</h5>
                            </div>
                        <div class="card-body text-center">
                            <img 
                                src="{% static 'img/Weekly_Frequency_-_Forecast.png' %}" 
                                class="img-fluid" 
                                alt="Weekly Future Forecast" 
                                style="max-height: 400px;"
                                onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No forecast data available';"
                            >
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Forecast Tab -->
                <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
                    <h4>Monthly Loan Disbursement Forecast</h4>
                    
                    <div class="row" id="monthly-historical-data">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Historical Data</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img 
                                        src="{% static 'img/Monthly_Frequency_-_Historical_Data.png' %}" 
                                        class="img-fluid" 
                                        alt="Monthly Historical Data" 
                                        style="max-height: 400px;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No historical data available';"
                                    >
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Model Performance</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img 
                                        src="{% static 'img/Monthly_Frequency_-_Model_Performance.png' %}" 
                                        class="img-fluid" 
                                        alt="Monthly Model Performance" 
                                        style="max-height: 400px;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No model performance data available';"
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Future Forecast -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Future Forecast</h5>
                        </div>
                        <div class="card-body text-center">
                            <img 
                                src="{% static 'img/Monthly_Frequency_-_Forecast.png' %}" 
                                class="img-fluid" 
                                alt="Monthly Future Forecast" 
                                style="max-height: 400px;"
                                onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No forecast data available';"
                            >
                        </div>
                    </div>
                </div>
                
                <!-- Quarterly Forecast Tab -->
                <div class="tab-pane fade" id="quarterly" role="tabpanel" aria-labelledby="quarterly-tab">
                    <h4>Quarterly Loan Disbursement Forecast</h4>
                    
                    <div class="row" id="quarterly-historical-data">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Historical Data</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img 
                                        src="{% static 'img/Quarterly_Frequency_-_Historical_Data.png' %}" 
                                        class="img-fluid" 
                                        alt="Quarterly Historical Data" 
                                        style="max-height: 400px;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No historical data available';"
                                    >
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Model Performance</h5>
                                </div>
                                <div class="card-body text-center">
                                    <img 
                                        src="{% static 'img/Quarterly_Frequency_-_Model_Performance.png' %}" 
                                        class="img-fluid" 
                                        alt="Quarterly Model Performance" 
                                        style="max-height: 400px;"
                                        onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No model performance data available';"
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Future Forecast -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Future Forecast</h5>
                        </div>
                        <div class="card-body text-center">
                            <img 
                                src="{% static 'img/Quarterly_Frequency_-_Forecast.png' %}" 
                                class="img-fluid" 
                                alt="Quarterly Future Forecast" 
                                style="max-height: 400px;"
                                onerror="this.onerror=null; this.src='/static/img/no_image.png'; this.alt='No forecast data available';"
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add script directly in the body -->
<script>
// Function to handle regenerate button click
function handleRegenerate() {
    const loadingIndicator = document.getElementById('regenerate-loading');
    const successMessage = document.getElementById('regenerate-success');
    const errorMessage = document.getElementById('regenerate-error');
    const regenerateBtn = document.getElementById('regenerate-forecasts');
    
    // Show loading indicator
    loadingIndicator.classList.remove('d-none');
    successMessage.classList.add('d-none');
    errorMessage.classList.add('d-none');
    
    // Disable the button while processing
    regenerateBtn.disabled = true;
    
    // Make AJAX request to generate new forecasts
    fetch('/area-manager/regenerate-forecasts/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
            loadingIndicator.classList.add('d-none');
            
            if (data.success) {
                // Show success message
                successMessage.classList.remove('d-none');
                
                // Refresh the images with a cache-busting parameter
                const timestamp = new Date().getTime();
                const images = document.querySelectorAll('img[src*="Frequency_-_"]');
                images.forEach(img => {
                    const originalSrc = img.src.split('?')[0];
                    img.src = originalSrc + '?' + timestamp;
                });
            } else {
                    // Show error message
                errorMessage.textContent = data.error || 'An error occurred while updating forecasts.';
                errorMessage.classList.remove('d-none');
            }
            
            // Re-enable the button
            regenerateBtn.disabled = false;
            })
            .catch(error => {
            // Hide loading indicator
            loadingIndicator.classList.add('d-none');
            
            // Show error message
            errorMessage.textContent = error.message || 'An error occurred while updating forecasts.';
            errorMessage.classList.remove('d-none');
            
            // Re-enable the button
            regenerateBtn.disabled = false;
        });
}
</script>
{% endblock %} 